# 長者詳情頁面 - 設備足跡功能

## 功能說明

在 Community Portal 的長者詳情頁面新增「設備足跡」區塊，顯示長者綁定設備的活動記錄。

---

## 訪問方式

1. 登入 Community Portal
2. 前往「長者管理」
3. 點擊任一長者卡片
4. 進入長者詳情頁面
5. 向下滾動，查看「設備足跡」區塊

**直接訪問**（需要先登入）：

```
https://safe-net-tw.web.app/community/elders/{長者ID}
```

---

## 顯示內容

### 頁面區塊

```
┌─────────────────────────────────────┐
│ 基本資料                             │
│ 姓名、性別、年齡...                  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 綁定設備                             │
│ 設備資訊、電池電量...                │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 設備足跡        [最近 24 小時 ▼]    │  ← 新增區塊
├─────────────────────────────────────┤
│ 社區大門                          │
│    2026/01/25 22:30:15             │
│    🔔 已發送通知  📶 -65 dBm  🕐 5分鐘前 │
│    [查看地圖位置]                    │
├─────────────────────────────────────┤
│ 活動中心                          │
│    2026/01/25 20:15:30             │
│    📶 -70 dBm  🕐 2小時前            │
└─────────────────────────────────────┘
```

### 時間範圍篩選

右上角下拉選單：

- 最近 6 小時
- 最近 12 小時
- 最近 24 小時（預設）
- 最近 3 天
- 最近 7 天

---

## 顯示的資訊

### 每一筆活動記錄包含

1. **位置資訊**
   - 接收器名稱（如「社區大門」）
   - 接收器類型標籤（安全區域/學校區域/觀察區域）

2. **時間資訊**
   - 完整時間戳記（yyyy/MM/dd HH:mm:ss）
   - 相對時間（X 分鐘前、X 小時前）

3. **信號資訊**
   - RSSI 信號強度（dBm）

4. **通知狀態**
   - 如果觸發了通知，顯示「已發送通知」標籤

5. **地圖連結**
   - 如果有 GPS 座標，顯示「查看地圖位置」連結
   - 點擊開啟 Google Maps

---

## 活動記錄來源

### 資料查詢

從 `devices/{deviceId}/activities` 子集合查詢：

```javascript
// 查詢條件
- 設備 ID = 長者綁定的設備
- bindingType = 'ELDER'（只顯示綁定給長者時的記錄）
- timestamp >= 最近 N 小時
- 排序：時間由新到舊
- 限制：最多 100 筆
```

### 資料結構

```javascript
// devices/{deviceId}/activities/{activityId}
{
  timestamp: Timestamp,
  gatewayId: "gateway_123",
  gatewayName: "社區大門",
  gatewayType: "SAFE_ZONE",
  latitude: 25.0330,
  longitude: 121.5654,
  rssi: -65,
  bindingType: "ELDER",
  boundTo: "elder_123",
  triggeredNotification: true,
  notificationType: "LINE"
}
```

---

## 使用場景

### 場景 1: 確認長者行蹤

查看長者今天去過哪些地方：

- 08:00 - 社區大門（外出）
- 09:30 - 公園（散步）
- 11:00 - 市場（買菜）
- 12:00 - 社區大門（回家）

### 場景 2: 核對通知記錄

確認哪些位置觸發了通知：

- 看到「已發送通知」標籤
- 與「通知記錄」頁面對照
- 確認通知設定正確

### 場景 3: 分析活動模式

長期觀察：

- 調整時間範圍到「最近 7 天」
- 查看長者的活動規律
- 了解常去的地點

### 場景 4: 緊急查找

如果長者失聯：

- 查看最後一次活動記錄
- 確認最後出現位置
- 點擊「查看地圖位置」

---

## UI 設計細節

### 顏色標籤

**接收器類型**：

- 🟢 安全區域（綠色）
- 🔵 學校區域（藍色）
- 🟡 觀察區域（黃色）
- ⚪ 未啟用（灰色）

**通知狀態**：

- 🔔 已發送通知（綠色文字）

### 時間顯示

- 絕對時間：`2026/01/25 22:30:15`
- 相對時間：`5 分鐘前`、`2 小時前`、`3 天前`

### 信號強度

- 顯示 RSSI 值（dBm）
- 越接近 0 越好（例如 -40 dBm 比 -80 dBm 好）

---

## 權限說明

### 所有角色都可以查看

- ADMIN 角色：✅ 查看
- MEMBER 角色：✅ 查看

足跡記錄是**只讀**的，任何人都無法修改或刪除。

---

## 如果沒有顯示活動記錄

### 情況 1: 長者未綁定設備

**顯示**：「設備足跡」區塊不出現

**解決**：為長者綁定設備

### 情況 2: 設備沒有活動記錄

**顯示**：「最近 X 小時無活動記錄」

**原因**：

- 設備尚未被任何接收器偵測到
- 設備電池耗盡
- 設備訊號被遮蔽

### 情況 3: 只有舊記錄

**顯示**：根據選擇的時間範圍顯示或不顯示

**解決**：調整時間範圍到「最近 7 天」

---

## 資料查詢邏輯

### 查詢流程

```
1. 從長者記錄取得 deviceId
   ↓
2. 查詢 devices/{deviceId}/activities
   ↓
3. 篩選條件：
   - bindingType = 'ELDER'
   - timestamp >= 最近 N 小時
   ↓
4. 排序：時間由新到舊
   ↓
5. 顯示在頁面
```

### 為什麼只顯示 ELDER 類型？

設備可能先綁定給地圖用戶，後來解綁再綁給長者。

只顯示 `bindingType = 'ELDER'` 的記錄，確保：

- 只看到長者使用期間的足跡
- 不會看到之前其他人的記錄

---

## 與通知記錄的區別

### 設備足跡（本頁面）

- 顯示**所有活動記錄**
- 包含有通知和無通知的記錄
- 按時間範圍篩選（6小時~7天）
- 顯示信號強度等技術資訊

### 通知記錄頁面

- 只顯示**已發送通知的記錄**
- `triggeredNotification = true`
- 可以按長者篩選（看所有長者）
- 顯示通知詳情（接收人數等）

---

## 測試步驟

### 1. 確認長者有綁定設備

在長者詳情頁面的「綁定設備」區塊確認有設備資訊。

### 2. 確認設備有活動記錄

在 Firestore Console 查看：

```
devices/{deviceId}/activities
```

確認有記錄且 `bindingType = 'ELDER'`

### 3. 訪問長者詳情頁面

```
https://safe-net-tw.web.app/community/elders/{長者ID}
```

### 4. 查看設備足跡

向下滾動到「設備足跡」區塊：

- [ ] 顯示活動記錄列表
- [ ] 每筆記錄顯示位置、時間、信號
- [ ] 有通知的記錄顯示「已發送通知」標籤
- [ ] 可以點擊「查看地圖位置」

### 5. 測試時間範圍篩選

- [ ] 切換到「最近 6 小時」
- [ ] 切換到「最近 7 天」
- [ ] 記錄數量隨時間範圍變化

---

## 模擬測試資料

### 使用 Beacon Test 建立足跡

1. 在 Admin 的「Line 通知測試」頁面
2. 選擇長者的設備資訊
3. 選擇不同的 gateway
4. 多次發送測試資料
5. 回到 Community Portal 查看足跡

---

## 部署狀態

✅ 已編譯成功（2026-01-25 22:31）

準備部署...
