# 通知點功能說明（正確版）

## 設計理念

### 為什麼顯示所有 Gateway？

**情境**：

- 系統中可能有很多接收器（Gateway）
- 這些接收器不一定預先分配給特定社區
- **Line OA 管理員自己選擇**哪些接收器要成為自己社區的通知點

### 運作方式

```
所有 Gateway（系統中的所有接收器）
       ↓
Community Portal 通知點頁面
顯示完整列表
       ↓
Line OA 管理員勾選
「我要用這個接收器作為通知點」
       ↓
建立記錄到 tenantNotificationPoints
{
  tenantId: "我的社區ID",
  gatewayId: "選擇的gateway",
  ...
}
       ↓
這個 gateway 成為該社區的通知點
```

---

## 實際操作流程

### 步驟 1: 登入 Community Portal

訪問：`https://safe-net-tw.web.app/community`

### 步驟 2: 前往通知點頁面

點擊側邊欄「通知點」

### 步驟 3: 瀏覽所有可用的接收器

頁面會顯示**系統中所有啟用的接收器**：

```
┌──────────────────────────────┐
│ ☐ 社區大門                    │  ← 接收器 A
│   台北市大安區XXX路           │
│   安全區域                    │
│   g-26-01-0001               │
└──────────────────────────────┘

┌──────────────────────────────┐
│ ☐ 活動中心                    │  ← 接收器 B
│   台北市大安區YYY路           │
│   觀察區域                    │
│   g-26-01-0002               │
└──────────────────────────────┘

┌──────────────────────────────┐
│ ☐ 公園入口                    │  ← 接收器 C
│   台北市大安區ZZZ路           │
│   安全區域                    │
│   g-26-01-0003               │
└──────────────────────────────┘
```

**注意**：這些接收器可能來自不同位置，不限於您的社區。

### 步驟 4: 選擇想要的接收器

**情境 1**：選擇社區入口

- 勾選「社區大門」
- 這個接收器現在成為**您社區的通知點**

**情境 2**：選擇附近的公共設施

- 勾選「公園入口」
- 即使這個接收器在社區外，也可以設為通知點
- 當長者經過公園時，您會收到通知

**情境 3**：多個接收器

- 可以勾選多個接收器
- 例如：社區大門、活動中心、公園
- 每個都會觸發通知

### 步驟 5: 設定自訂訊息

勾選後：

- 輸入：「長者經過社區大門」
- 點擊「更新」
- 訊息保存

---

## 資料結構

### tenantNotificationPoints 集合

當社區 A 勾選接收器時：

```javascript
{
  id: "point_001",
  tenantId: "社區A的ID",           // 您的社區
  gatewayId: "gateway_123",        // 您選擇的接收器
  name: "社區大門",
  notificationMessage: "長者經過社區大門",
  isActive: true
}
```

### 同一個 Gateway，不同社區可以各自設定

```javascript
// 社區 A 的通知點
{
  tenantId: "社區A",
  gatewayId: "gateway_123",  // 同一個接收器
  notificationMessage: "社區A：長者回家了"
}

// 社區 B 的通知點
{
  tenantId: "社區B",
  gatewayId: "gateway_123",  // 同一個接收器
  notificationMessage: "社區B：長者外出了"
}
```

**結果**：

- 當長者 A 經過 gateway_123 → 社區 A 的成員收到「社區A：長者回家了」
- 當長者 B 經過 gateway_123 → 社區 B 的成員收到「社區B：長者外出了」

---

## UI 說明

### 顯示邏輯

頁面上的每個 Gateway 卡片：

**未勾選**（還不是您社區的通知點）：

```
┌──────────────────────────────┐
│ ☐ 社區大門                    │  ← 空勾選框
│   台北市大安區XXX路           │
│   安全區域                    │
└──────────────────────────────┘
```

**已勾選**（已加入您社區的通知點）：

```
┌──────────────────────────────┐
│ ☑ 社區大門                    │  ← 打勾
│   台北市大安區XXX路           │
│   ✓ 已設為通知點              │  ← 綠色標籤
│                              │
│   自訂通知訊息：              │
│   [長者經過社區大門_______] [更新]  ← 可編輯
└──────────────────────────────┘
```

### 權限

- **ADMIN 角色**：可以勾選/取消勾選任何接收器
- **MEMBER 角色**：只能查看哪些是通知點

---

## 使用場景

### 場景 1: 社區入口監控

選擇社區入口的接收器：

- 勾選「社區大門」
- 訊息：「長者進入社區」
- 效果：長者回家時通知家屬

### 場景 2: 活動參與追蹤

選擇活動場所的接收器：

- 勾選「活動中心」
- 訊息：「長者參加社區活動」
- 效果：確認長者有參與活動

### 場景 3: 外出提醒

選擇多個接收器：

- 勾選「社區大門」
- 勾選「公園入口」
- 勾選「市場」
- 效果：長者外出路徑全程掌握

### 場景 4: 跨社區監控

社區 A 可以選擇社區 B 附近的接收器：

- 勾選「社區B大門」
- 訊息：「長者前往鄰近社區」
- 效果：擴大監控範圍

---

## 優勢

### 1. 彈性選擇

- 不限於自己社區的接收器
- 可以選擇任何系統中的接收器
- 適應各種監控需求

### 2. 自主管理

- Line OA 管理員自行決定
- 不需要請求系統管理員
- 隨時調整，即時生效

### 3. 資料隔離

- 每個社區的設定是獨立的
- 不會影響其他社區
- 同一個接收器可以被多個社區使用

---

## 與 Gateway 管理的關係

### Admin「GateWay 管理」（系統管理員）

**功能**：

- 新增實體接收器設備
- 設定技術參數（序號、MAC、GPS）
- 管理接收器的基本資訊

**特點**：

- Gateway 不一定要分配給特定社區
- 可以設定 tenantId，也可以不設定
- 所有接收器都可以被任何社區選用

### Community Portal「通知點」（Line OA 管理員）

**功能**：

- 從所有接收器中選擇
- 加入到自己社區的通知點
- 設定自訂通知訊息

**特點**：

- 看得到所有接收器
- 只能管理自己社區的通知點設定
- 勾選 = 加入到我的社區

---

## 修正後的查詢邏輯

### 查詢所有 Gateway

```typescript
// 不限 tenantId，顯示所有啟用的接收器
query(
  collection(db, "gateways"),
  where("isActive", "==", true),
  orderBy("createdAt", "desc"),
);
```

### 判斷是否為通知點

```typescript
// 檢查該 gateway 是否在我社區的通知點列表中
notificationPoints.some(
  (point) =>
    point.gatewayId === gateway.id &&
    point.tenantId === 我的社區ID &&
    point.isActive === true,
);
```

---

## 測試步驟

### 1. 訪問通知點頁面

```
https://safe-net-tw.web.app/community/notification-points
```

### 2. 確認顯示所有接收器

應該看到：

- [ ] 系統中所有的接收器
- [ ] 不限於您的社區
- [ ] 每個接收器前面有勾選框

### 3. 選擇接收器

- 勾選想要的接收器
- 設定自訂訊息
- 點擊「更新」

### 4. 確認設定成功

在 Firestore Console 查看 `tenantNotificationPoints`：

```javascript
{
  tenantId: "YOUR_TENANT_ID",  // 您的社區 ID
  gatewayId: "gateway_xxx",    // 您選擇的接收器
  name: "接收器名稱",
  notificationMessage: "自訂訊息",
  isActive: true
}
```

---

## 部署狀態

✅ 已部署到生產環境（2026-01-25 22:28）

修正內容：

- 查詢邏輯改為顯示所有 gateways
- UI 文字更新，說明可以從所有接收器中選擇
- 資料仍然記錄在各社區自己的通知點中

---

## 立即測試

訪問：`https://safe-net-tw.web.app/community/notification-points`

應該能看到：

- 所有系統中的接收器
- 可以自由選擇勾選
- 勾選後加入到您社區的通知點

---

這樣設計更靈活，Line OA 管理員可以自主選擇任何接收器作為通知點！
