# 通知格式統一更新

## 更新時間
2026-01-25 22:45

## 部署狀態
✅ 已部署到生產環境

---

## 變更內容

### 移除自訂通知訊息功能

**變更前**：
- 通知點頁面有「自訂通知訊息」輸入框
- 可以為每個通知點設定不同訊息
- 需要點擊「更新」按鈕保存

**變更後**：
- 移除自訂訊息輸入框
- 統一使用固定格式
- 勾選即完成，無需額外設定

---

## 統一通知格式

### LINE 通知內容

```
─────────────────────────────
新偵測通知
─────────────────────────────
{長輩姓名} 出現在 {位置} 附近

長輩：王小明
地點：社區大門
時間：2026/01/25 22:30

[查看地圖]
─────────────────────────────
```

### 格式說明

**標題**：
```
新偵測通知
```

**主要內容**：
```
{長輩姓名} 出現在 {位置} 附近
```

**位置來源**（優先順序）：
1. `gateway.location`（位置欄位，如「台北市大安區XX路」）
2. `gateway.name`（名稱欄位，如「社區大門」）
3. 「未知位置」（備用）

---

## 通知點 UI 變更

### 新的介面

```
┌──────────────────────────────────┐
│ ☑ 社區大門                        │
│   台北市大安區XX路                │
│   安全區域                        │
│   g-26-01-0001                   │
│                                  │
│   ✓ 已設為通知點                 │
│                                  │
│   通知格式：                      │
│   標題：新偵測通知                │
│   內容：[長輩姓名] 出現在         │
│         台北市大安區XX路 附近     │
└──────────────────────────────────┘
```

**移除的內容**：
- ❌ 自訂通知訊息輸入框
- ❌ 「更新」按鈕
- ❌ 「重新整理」按鈕

**保留的內容**：
- ✅ 勾選框
- ✅ Gateway 資訊
- ✅ 「已設為通知點」標籤
- ✅ 通知格式說明（新增）

---

## 優勢

### 1. 簡化操作

**舊流程**：
```
勾選 → 輸入自訂訊息 → 點擊更新 → 完成
```

**新流程**：
```
勾選 → 完成
```

### 2. 統一體驗

- 所有社區的通知格式一致
- 用戶一看就懂
- 不會因為訊息不當造成困擾

### 3. 減少錯誤

- 不會輸入不適當的訊息
- 不會忘記設定訊息
- 降低維護成本

---

## 技術實作

### Cloud Functions 修改

**檔案**：`functions/src/beacon/receiveBeaconData.ts`

**通知訊息組成**：
```typescript
const elderName = elder?.name || '長輩';
const locationText = gateway.location || notificationPoint.name || '未知位置';
const notificationMessage = `${elderName} 出現在 ${locationText} 附近`;
```

**標題**：
```typescript
altText: `新偵測通知 - ${elderName}`
header: { text: '新偵測通知' }
```

### Community Portal 修改

**檔案**：`community-portal/src/screens/notification-points/NotificationPointsScreen.tsx`

**移除的功能**：
- editingMessages 狀態
- handleUpdateMessage 函數
- handleMessageChange 函數
- 自訂訊息輸入框和更新按鈕

**新增的顯示**：
- 通知格式預覽區塊（藍色底）
- 顯示實際會發送的訊息格式

---

## 測試步驟

### 1. 查看通知點頁面

訪問：`https://safe-net-tw.web.app/community/notification-points`

**驗證**：
- [ ] 沒有自訂訊息輸入框
- [ ] 沒有「更新」按鈕
- [ ] 勾選後顯示通知格式說明

### 2. 勾選通知點

勾選一個 gateway。

**驗證**：
- [ ] 勾選框打勾
- [ ] 顯示「已設為通知點」標籤
- [ ] 顯示通知格式預覽
- [ ] 格式顯示：「[長輩姓名] 出現在 [該位置] 附近」

### 3. 測試 LINE 通知

使用 Admin 的 Beacon Test 發送測試。

**驗證 LINE 通知內容**：
- [ ] 標題：「新偵測通知」
- [ ] 內容：「[長輩姓名] 出現在 [位置] 附近」
- [ ] 顯示長輩姓名
- [ ] 顯示位置（gateway.location 或 gateway.name）
- [ ] 顯示時間
- [ ] 有「查看地圖」按鈕

---

## 通知範例

### 範例 1：社區大門

**Gateway 設定**：
```
name: "社區大門"
location: "台北市大安區XX路1號"
```

**通知內容**：
```
新偵測通知
─────────────────
王小明 出現在 台北市大安區XX路1號 附近

長輩：王小明
地點：社區大門
時間：2026/01/25 22:30
```

### 範例 2：活動中心

**Gateway 設定**：
```
name: "活動中心"
location: "社區2樓"
```

**通知內容**：
```
新偵測通知
─────────────────
李奶奶 出現在 社區2樓 附近

長輩：李奶奶
地點：活動中心
時間：2026/01/25 15:00
```

---

## Gateway location 欄位重要性

### 為什麼 location 很重要？

通知訊息使用 `gateway.location`，所以：

**好的 location**：
```
location: "台北市大安區XX路1號"
→ 通知：出現在 台北市大安區XX路1號 附近
→ ✅ 清楚明確
```

**不好的 location**：
```
location: "" (空白)
→ 通知：出現在 社區大門 附近
→ ⚠️ 用 gateway.name 替代
```

### 建議

在 Admin 的「GateWay 管理」：
- 為每個 gateway 設定清楚的 location
- 例如：「台北市大安區XX路1號」、「社區2樓活動中心」
- 這樣通知訊息會更明確

---

## 與舊版本對比

| 項目 | 舊版（自訂訊息） | 新版（統一格式） |
|------|----------------|----------------|
| 操作步驟 | 勾選 + 輸入 + 更新 | 勾選 |
| 訊息內容 | 自由輸入 | 統一格式 |
| 維護成本 | 需要管理多個訊息 | 無需維護 |
| 一致性 | 各社區不同 | 所有社區統一 |
| 錯誤風險 | 可能輸入不當訊息 | 無風險 |

---

## 資料結構

### tenantNotificationPoints

**不再需要的欄位**：
- `notificationMessage`（已移除使用）

**保留的欄位**：
```javascript
{
  id: "point_001",
  tenantId: "community_001",
  gatewayId: "gateway_001",
  name: "社區大門",
  notifyOnElderActivity: true,
  isActive: true,
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

**注意**：舊的記錄可能還有 `notificationMessage` 欄位，但已不會被使用。

---

## 部署資訊

### 已更新內容

1. ✅ Community Portal 通知點 UI
   - 移除自訂訊息輸入
   - 添加通知格式預覽

2. ✅ Cloud Functions 通知訊息
   - 統一格式：「{長輩} 出現在 {位置} 附近」
   - 標題：「新偵測通知」

3. ✅ 部署狀態
   - Hosting: 15 個文件
   - Functions: 29 個已更新
   - 全部部署成功

---

## 立即測試

### 訪問通知點頁面

```
https://safe-net-tw.web.app/community/notification-points
```

### 測試流程

1. **勾選一個 gateway**
   - ✅ 立即成為通知點
   - ✅ 看到通知格式預覽

2. **發送測試**
   - 在 Admin Beacon Test 發送
   - 等待 LINE 通知

3. **確認通知格式**
   - 標題：「新偵測通知」
   - 內容：「[長輩] 出現在 [位置] 附近」

---

## 完成

所有變更已部署並生效：
- ✅ 移除自訂訊息功能
- ✅ 統一通知格式
- ✅ 簡化操作流程
- ✅ UI 更新完成
- ✅ Cloud Functions 更新完成

立即使用：`https://safe-net-tw.web.app/community/notification-points`
