# 通知記錄查詢修正

## 問題描述

LINE 有收到通知，但 Community Portal 的「通知記錄」頁面沒有顯示任何資料。

---

## 問題原因

### 查詢邏輯錯誤

**錯誤的查詢**（修正前）：
```typescript
// 從 elders/{elderId}/activities 查詢
collection(db, 'elders', elderId, 'activities')
```

**正確的查詢**（修正後）：
```typescript
// 從 devices/{deviceId}/activities 查詢
collection(db, 'devices', deviceId, 'activities')
```

### 為什麼？

**Cloud Functions 記錄位置**：

在 `receiveBeaconData.ts` 中：
```typescript
// 第 781-783 行
await db.collection('devices').doc(deviceId)
  .collection('activities')
  .add(activityData);
```

活動記錄是存在 **devices 的子集合**，不是 elders 的子集合。

---

## 修正內容

### 修改檔案

**1. activityService.ts**

**修正前**：
```typescript
getNotificationLogs: async (elderIds: string[]) => {
  for (const elderId of elderIds) {
    // 錯誤：查詢 elders/{elderId}/activities
    const activitiesRef = collection(db, 'elders', elderId, 'activities');
  }
}
```

**修正後**：
```typescript
getNotificationLogs: async (elders: { id, name, deviceId }[]) => {
  // 只查詢有綁定設備的長者
  const eldersWithDevices = elders.filter(e => e.deviceId);
  
  for (const elder of eldersWithDevices) {
    // 正確：查詢 devices/{deviceId}/activities
    const activitiesRef = collection(db, 'devices', elder.deviceId, 'activities');
    
    // 查詢條件
    where('triggeredNotification', '==', true),
    where('notificationType', '==', 'LINE'),
    where('bindingType', '==', 'ELDER'),  // 只查詢綁定給長者時的記錄
  }
}
```

**2. NotificationLogsScreen.tsx**

修改調用方式，傳遞完整的長者資料（包含 deviceId）：

```typescript
// 修正前
await loadLogs(data.map(e => e.id));  // 只傳 ID

// 修正後
await loadLogs(data);  // 傳完整的長者物件（包含 deviceId）
```

---

## 查詢邏輯說明

### 為什麼要查詢 devices/activities？

**資料架構**：
```
devices/{deviceId}
└── activities (子集合)
    ├── {activityId}
    │   ├── timestamp
    │   ├── gatewayId
    │   ├── gatewayName
    │   ├── bindingType: "ELDER"
    │   ├── boundTo: "elder_id"
    │   ├── triggeredNotification: true
    │   └── notificationType: "LINE"
    └── ...
```

**為什麼這樣設計？**：
1. 設備可能先綁給地圖用戶，後來改綁給長者
2. 活動記錄跟著設備走，不跟長者
3. 透過 `bindingType` 區分是誰使用時的記錄

### 查詢條件

```typescript
where('triggeredNotification', '==', true),  // 有發送通知
where('notificationType', '==', 'LINE'),     // LINE 通知（不是 FCM）
where('bindingType', '==', 'ELDER'),         // 綁定給長者時的記錄
```

---

## 修正效果

### 修正前
- LINE 收到通知 ✅
- Cloud Functions 記錄到 devices/activities ✅
- Community Portal 查詢 elders/activities ❌
- 通知記錄頁面顯示空 ❌

### 修正後
- LINE 收到通知 ✅
- Cloud Functions 記錄到 devices/activities ✅
- Community Portal 查詢 devices/activities ✅
- 通知記錄頁面顯示記錄 ✅

---

## 測試步驟

### 1. 發送測試通知

在 Admin「Line 通知測試」：
1. 選擇長者的設備（UUID/Major/Minor）
2. 選擇通知點的 gateway
3. 點擊「發送測試資料」
4. 確認 LINE 收到通知

### 2. 查看通知記錄

訪問：`https://safe-net-tw.web.app/community/notification-logs`

**應該看到**：
- [ ] 顯示剛才的通知記錄
- [ ] 長者姓名正確
- [ ] 位置資訊正確
- [ ] 時間正確
- [ ] 類型標籤正確

### 3. 測試篩選

**按長者篩選**：
- 選擇特定長者
- 點擊「套用篩選」
- 只顯示該長者的記錄

**按日期篩選**：
- 設定開始/結束日期
- 點擊「套用篩選」
- 只顯示該時間範圍的記錄

---

## 重要提醒

### 必須有綁定設備

**如果長者沒有綁定設備**：
- 不會查詢（因為沒有 deviceId）
- 通知記錄不會顯示該長者

**原因**：
- 活動記錄存在設備的子集合
- 沒有設備 = 沒有活動記錄

### 只顯示 ELDER 類型

查詢條件包含 `bindingType == 'ELDER'`：
- 只顯示設備綁定給長者時的記錄
- 之前綁定給地圖用戶的記錄不會顯示
- 解綁後再綁定給其他人的記錄不會顯示

---

## 與設備足跡的關係

### 兩者的差異

**通知記錄頁面**：
- 查詢來源：`devices/{deviceId}/activities`
- 條件：`triggeredNotification == true`
- 顯示：所有社區長者的通知記錄
- 可以按長者篩選

**設備足跡（長者詳情）**：
- 查詢來源：`devices/{deviceId}/activities`
- 條件：`bindingType == 'ELDER'`（不限是否有通知）
- 顯示：該長者的所有活動
- 可以按時間範圍篩選

### 相同點

- 都從 `devices/{deviceId}/activities` 查詢
- 都過濾 `bindingType == 'ELDER'`

### 不同點

- 通知記錄：只顯示有通知的（triggeredNotification）
- 設備足跡：顯示所有活動（包含沒通知的）

---

## 部署狀態

✅ 已編譯並部署

修正時間：2026-01-25 22:54

---

## 立即驗證

### 步驟 1: 發送測試

使用 Admin Beacon Test 發送一次測試

### 步驟 2: 查看通知記錄

訪問：`https://safe-net-tw.web.app/community/notification-logs`

**應該看到**：
- 顯示通知記錄（不再是空的）
- 長者姓名
- 位置資訊
- 時間戳記

### 步驟 3: 對比設備足跡

訪問長者詳情頁面，查看設備足跡：
```
https://safe-net-tw.web.app/community/elders/{長者ID}
```

**應該看到**：
- 設備足跡有更多記錄（包含沒通知的）
- 有通知的記錄標示「已發送通知」

---

## 除錯提示

### 如果還是沒有顯示

**檢查 1：長者是否有綁定設備？**
- 在長者列表查看「設備狀態」欄位
- 如果顯示「未綁定」→ 不會有記錄

**檢查 2：Firestore 是否有資料？**
```
Collection: devices/{長者的deviceId}/activities
Filters: 
  - triggeredNotification == true
  - notificationType == 'LINE'
  - bindingType == 'ELDER'
```

**檢查 3：瀏覽器 Console**
- 開啟開發者工具（F12）
- 查看 Console 是否有錯誤訊息

---

## 修正完成

通知記錄查詢邏輯已修正：
- ✅ 從正確的集合查詢（devices/activities）
- ✅ 只查詢有綁定設備的長者
- ✅ 過濾條件正確
- ✅ 長者姓名正確顯示

立即測試：`https://safe-net-tw.web.app/community/notification-logs`

現在應該可以看到通知記錄了！
