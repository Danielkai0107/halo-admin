# 測試同時登入功能

## 已部署修正版本

部署時間：2026-01-25 22:34

修正內容：

- Admin 使用 'AdminApp' 實例名稱
- Community Portal 使用 'CommunityPortalApp' 實例名稱
- 認證狀態理論上已隔離

---

## 快速測試（3 分鐘）

### 步驟 1: 準備瀏覽器

**選項 A：使用無痕模式（推薦）**

```
Cmd+Shift+N (Mac) 或 Ctrl+Shift+N (Windows)
開啟無痕視窗
```

**選項 B：清除快取**

```
1. 開發者工具（F12）
2. Application → Storage → Clear site data
3. 勾選所有選項並清除
```

### 步驟 2: 登入 Admin

1. **訪問**：`https://safe-net-tw.web.app`
2. **登入**：使用 SUPER_ADMIN 帳號
3. **確認**：看到 Dashboard 和側邊欄
4. **保持此分頁開啟**

### 步驟 3: 登入 Community Portal

1. **開新分頁**（Cmd+T 或 Ctrl+T）
2. **訪問**：`https://safe-net-tw.web.app/community`
3. **登入**：使用 SaaS 用戶帳號
4. **確認**：看到長者管理頁面

### 步驟 4: 驗證不會互相登出

**切換回 Admin 分頁**：

- ✅ 應該仍然登入
- ✅ 可以正常使用
- ✅ 沒有重定向到登入頁

**切換回 Community Portal 分頁**：

- ✅ 應該仍然登入
- ✅ 可以正常使用
- ✅ 沒有重定向到登入頁

### 步驟 5: 測試操作

**在 Admin 分頁**：

- 前往「SaaS 用戶管理」
- 瀏覽用戶列表
- 嘗試篩選或查看

**在 Community Portal 分頁**：

- 前往「長者管理」
- 點擊一個長者查看詳情
- 查看設備足跡

**來回切換 3-5 次**：

- [ ] Admin 始終保持登入
- [ ] Community Portal 始終保持登入

---

## 測試結果判定

### ✅ 測試通過

如果：

- 兩個應用可以同時登入
- 來回切換不會被登出
- 都可以正常操作

**結果**：認證隔離成功！

### ❌ 測試失敗

如果：

- 登入一個會登出另一個
- 切換分頁後被登出
- 需要重新登入

**下一步**：需要實施進階解決方案（參考 AUTH_ISOLATION_FIX.md）

---

## 多客戶測試

### 測試場景

**模擬 3 個Line OA 管理員同時使用**：

**方法 1：使用不同瀏覽器**

```
Chrome → 社區 A 管理員登入
Firefox → 社區 B 管理員登入
Safari → 社區 C 管理員登入
```

**方法 2：使用不同的無痕視窗**

```
無痕視窗 1 → 社區 A
無痕視窗 2 → 社區 B
無痕視窗 3 → 社區 C
```

**方法 3：使用不同電腦/設備**

```
電腦 A → 社區 A
電腦 B → 社區 B
平板 → 社區 C
手機 → 社區 D
```

**預期結果**：

- ✅ 每個管理員獨立登入
- ✅ 互不干擾
- ✅ 可以同時操作

---

## 檢查 localStorage

### 開發者工具檢查

1. **開啟開發者工具**（F12）
2. **切換到 Application 標籤**
3. **展開 Local Storage**
4. **點擊 `https://safe-net-tw.web.app`**
5. **查看 key 列表**

### 應該看到的 Keys

**如果兩個應用都登入**：

```
firebase:authUser:AdminApp:AIzaSy...
  → Admin 的認證狀態

firebase:authUser:CommunityPortalApp:AIzaSy...
  → Community Portal 的認證狀態

其他 Firebase 相關 keys...
```

### 異常情況

**只看到一組 key**：

- 修正可能沒有生效
- 需要確認部署的版本

**看到重複的 keys**：

- 可能是舊快取
- 清除後重新測試

---

## 實際使用場景

### 場景 1: 系統管理員操作

**需求**：

- 在 Admin 管理所有社區
- 同時在 Community Portal 測試某個社區的功能

**操作**：

- 分頁 1：Admin（admin@company.com）
- 分頁 2：Community Portal（admin@community-a.com）
- ✅ 可以同時登入，互不干擾

### 場景 2: 多個Line OA 管理員

**需求**：

- 社區 A 管理員使用 Community Portal
- 社區 B 管理員使用 Community Portal
- 社區 C 管理員使用 Community Portal

**操作**：

- 每個管理員在自己的設備/瀏覽器登入
- ✅ 完全獨立，不會互相影響

### 場景 3: 培訓演示

**需求**：

- 講師在大螢幕展示 Admin
- 學員在自己電腦操作 Community Portal

**操作**：

- 講師：Admin（投影到大螢幕）
- 學員：Community Portal（各自登入）
- ✅ 不會互相干擾

---

## 常見問題

### Q: 為什麼之前會互相登出？

A: 因為兩個應用使用相同的 Firebase app 實例（默認實例），導致認證狀態共用同一個 localStorage key，互相覆蓋。

### Q: 修正後為什麼不會了？

A: 給每個應用設置唯一的名稱後，Firebase SDK 會為每個應用使用不同的 localStorage key，認證狀態完全隔離。

### Q: 多個客戶會互相干擾嗎？

A: 不會。只要：

- 不是同一台電腦的同一個瀏覽器
- 或使用不同的瀏覽器 profile
  就完全獨立，不會干擾。

### Q: 同一個人可以同時管理多個社區嗎？

A: 目前設計是一個 SaaS 帳號對應一個社區（tenantId）。

如果需要管理多個社區：

- 方法 1：建立多個帳號（每個社區一個）
- 方法 2：未來擴展為多社區支援（tenantIds 陣列）

### Q: LIFF App 會受影響嗎？

A: 不會。LIFF App 使用 LINE 登入（不是 Firebase Auth），完全獨立的認證系統。

---

## 技術說明

### Firebase App 實例命名

```typescript
// 默認實例（會衝突）
const app = initializeApp(config);

// 命名實例（不會衝突）
const app1 = initializeApp(config, "App1");
const app2 = initializeApp(config, "App2");
```

### localStorage Key 格式

```
firebase:authUser:[APP_NAME]:[API_KEY]:...
```

不同的 APP_NAME → 不同的 key → 不會衝突

---

## 回滾方案

如果修正後出現其他問題，可以回滾：

```bash
git checkout HEAD~1
npm run build
cd community-portal && npm run build && cd ..
firebase deploy --only hosting
```

但這會恢復到會互相登出的版本。

---

## 監控建議

部署後觀察：

- 是否有用戶回報被登出
- 是否有多人同時使用的問題
- Firebase Console 的認證活動

---

## 成功指標

- [ ] Admin 和 Community Portal 可以同時登入
- [ ] 多個Line OA 管理員可以同時使用
- [ ] 沒有互相登出的問題
- [ ] 用戶體驗流暢

---

**請立即測試並回報結果！**

測試成功後，這個問題就徹底解決了。
