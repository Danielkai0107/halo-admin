# 首次活動通知功能完成

## 部署時間

2026-01-25 23:10

## 部署狀態

✅ 全部完成

---

## 更新內容

### 1. 新增：今日首次活動通知 ✅

**觸發條件**：

- 長者設備今天第一次被偵測到
- 比較 `lastActivityAt` 的日期與當前日期
- 日期不同 = 今日首次活動

**通知格式**：

```
標題：{長輩姓名} 今日首次活動

內容：{長輩姓名} 今日首次在 {位置} 被偵測到

詳細資訊：
- 長輩：王小明
- 地點：台北市大安區XX路1號
- 時間：2026/01/25 08:30

[查看地圖]
```

**優先級**：最高（優先於通知點通知）

---

### 2. 移除：警報系統通知 ✅

**已移除警報分配、回應、完成通知的觸發**

**保留檔案**：

- `functions/src/alerts/assignment.ts`
- `functions/src/alerts/response.ts`
- `functions/src/alerts/completion.ts`

這些 Cloud Functions 仍然存在，但 Community Portal 不使用警報功能。

**移除原因**：

- Community Portal 專注於長者管理和通知點
- 警報系統是 LIFF App 的功能
- 簡化通知邏輯

---

### 3. 重新應用：所有關鍵修改 ✅

**line_users 統一**：

- 所有查詢使用 `line_users` 集合
- 不再使用 `appUsers`

**Gateway 類型更新**：

- SCHOOL_ZONE（學校區域）
- SAFE_ZONE（安全區域）
- OBSERVE_ZONE（觀察區域）
- INACTIVE（停用）

**通知點功能**：

- sendTenantNotificationPointAlert 函數完整
- Community Portal 勾選通知點正常運作

**最後活動更新**：

- 每次設備活動更新 elder.lastActivityAt
- Table 顯示正確

---

## 通知優先順序（最終版）

### 長者設備經過 Gateway 時

```
1. 檢查：是否為今日首次活動？
   └─ 是 → 發送「今日首次活動」通知
          （標題：{長輩} 今日首次活動）
          停止，不再檢查後續

2. 檢查：Gateway 是否為通知點？
   └─ 是 → 發送「新偵測通知」
          （標題：新偵測通知）
          （內容：{長輩} 出現在 {位置} 附近）
          停止

3. 都不是 → 不發送通知
```

**優先級規則**：

- **首次活動 > 通知點 > 不發送**

---

## LINE 通知完整清單（最終版）

### Community Portal 控制的通知

| 通知類型     | 觸發條件             | 優先級    | 狀態        |
| ------------ | -------------------- | --------- | ----------- |
| 今日首次活動 | 長者今天第一次被偵測 | 1（最高） | ✅ 自動     |
| 通知點通知   | 經過已勾選的 gateway | 2         | ✅ 手動設定 |

### LIFF App 的通知（保留）

| 通知類型   | 觸發條件            | 狀態    |
| ---------- | ------------------- | ------- |
| 不活躍警報 | 定時檢查（每天3次） | ✅ 自動 |
| 警報分配   | 管理員分配警報      | ✅ 手動 |
| 警報回應   | 成員接受/拒絕       | ✅ 手動 |
| 警報完成   | 成員標記完成        | ✅ 手動 |

---

## 今日首次活動通知的價值

### 對社區成員

**安心確認**：

- 每天早上收到通知
- 確認長輩今天有外出活動
- 代表長輩狀況正常

**早期預警**：

- 如果某天沒收到首次活動通知
- 可能表示長輩今天未外出
- 可以主動關懷

### 對Line OA 管理員

**每日確認**：

- Dashboard 看到今日通知數
- 快速確認多少位長輩有活動
- 關注沒有首次活動的長輩

**模式了解**：

- 了解長輩的外出時間
- 評估社區活動參與度
- 安排服務時間

---

## 使用場景

### 場景 1：每天早上

**8:00-10:00**：

- 長輩們陸續外出
- 經過社區大門或活動中心
- 社區成員收到「今日首次活動」通知
- 確認長輩有正常活動

### 場景 2：關懷機制

**12:00**：

- Line OA 管理員查看 Dashboard
- 檢查「今日通知數」
- 發現某些長輩沒有首次活動通知
- 安排志工電話關懷或訪視

### 場景 3：家屬安心

**家屬早上出門上班前**：

- 收到「王伯伯 今日首次活動」通知
- 確認父親今天有外出
- 安心去上班

---

## 測試步驟

### 1. 模擬今日首次活動

**準備**：

1. 確認長者有綁定設備
2. 確認 `lastActivityAt` 是昨天或更早的日期

**執行**：

1. 在 Admin「Line 通知測試」
2. 選擇長者的設備
3. 選擇任一 gateway
4. 發送測試資料

**預期結果**：

- ✅ LINE 收到通知
- ✅ 標題：「王小明 今日首次活動」
- ✅ 內容：「王小明 今日首次在 XX 被偵測到」
- ✅ Community Portal「通知記錄」出現
- ✅ 長者 Table「最後活動」更新

### 2. 測試不會重複發送

**同一天再次發送**：

1. 在同一天再次發送測試資料
2. **預期結果**：
   - 不會發送首次活動通知（因為今天已經有活動了）
   - 如果該 gateway 是通知點 → 發送「新偵測通知」
   - 如果不是通知點 → 不發送通知

### 3. 測試隔天重置

**第二天測試**：

1. 等到隔天（或手動修改 Firestore 的 lastActivityAt 為昨天）
2. 再次發送測試資料
3. **預期結果**：
   - 再次發送「今日首次活動」通知
   - 因為日期已經不同了

---

## 技術實作

### checkIfFirstActivityToday 函數

**邏輯**：

```typescript
1. 查詢長者的 lastActivityAt
2. 如果為空 → return true（從未活動）
3. 將 lastActivityAt 轉為日期字串（只比年月日）
4. 將當前時間轉為日期字串（只比年月日）
5. 比較兩個日期字串
6. 不同 → return true（今日首次）
7. 相同 → return false（今日已有活動）
```

**時區處理**：

- 使用台北時區（Asia/Taipei）
- 確保日期判斷正確

### 主流程整合

**receiveBeaconData 處理流程**：

```
1. 找到設備
2. 更新設備狀態
3. 檢查是否為今日首次活動
4. 處理通知（傳入 isFirstActivityToday）
5. 更新長者 lastActivityAt
6. 記錄活動
```

**handleElderNotification 判斷順序**：

```
if (isFirstActivityToday) {
  → 發送首次活動通知
  → return
}

if (是通知點) {
  → 發送通知點通知
  → return
}

→ 不發送通知
```

---

## Cloud Functions 日誌

### 成功訊息

**首次活動**：

```
Elder 王小明 first activity today
Sent first activity notification to member U123...
Updated elder elder_001 lastActivityAt
```

**通知點**：

```
Elder 王小明 passed through notification point: 社區大門
Sent notification point alert to member U123...
```

**無通知**：

```
No notification sent for elder elder_001 (not first activity, not notification point)
```

---

## 部署確認

### 已部署內容

**Hosting（27 files）**：

- Admin
- Community Portal（含 Dashboard）
- LIFF

**Functions（29 functions）**：

- receiveBeaconData（已更新）
- 所有其他 functions

**Firestore**：

- Rules 已部署
- Indexes 已部署

---

## 完整功能確認

### Community Portal 所有功能

1. ✅ Dashboard（數據總覽 + 報告匯出）
2. ✅ 長者管理（Table + Modal + 設備選擇）
3. ✅ 設備清單（Table + 詳情 Modal）
4. ✅ 通知記錄（查詢正確）
5. ✅ 通知點（Table + Modal 選擇）
6. ✅ 設備足跡（時間篩選）

### LINE 通知系統

1. ✅ **今日首次活動通知**（新增）
2. ✅ 通知點通知（Community Portal 設定）
3. ✅ 不活躍警報（定時任務）
4. ✅ 警報相關通知（LIFF App）

---

## 完成！

所有修改已完成並部署到生產環境：

- ✅ 首次活動通知功能
- ✅ 通知點功能恢復
- ✅ line_users 集合統一
- ✅ 最後活動時間更新
- ✅ Gateway 類型正確
- ✅ Dashboard 功能完整

**立即測試**：

1. 訪問：https://safe-net-tw.web.app/community
2. 發送測試資料
3. 確認收到「今日首次活動」通知
4. 同一天再發送 → 確認不會重複
