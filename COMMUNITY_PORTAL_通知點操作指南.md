# Community Portal 通知點操作指南

## 功能說明

社區管理員可以在 Community Portal 中**直接操作通知點**，完全不需要訪問 Admin 後台。

---

## 操作流程

### 步驟 1: 登入 Community Portal

訪問：`https://safe-net-tw.web.app/community`

使用您的社區管理員帳號登入（在 Admin 建立的 SaaS 用戶）

### 步驟 2: 前往通知點頁面

點擊側邊欄的「通知點」或訪問：
```
https://safe-net-tw.web.app/community/notification-points
```

### 步驟 3: 查看社區的接收器列表

頁面會自動載入**您社區的所有接收器（Gateways）**：

```
┌──────────────────────────────┐
│ ☐ 社區大門                    │
│   台北市大安區XXX路           │
│   安全區域                    │
│   g-26-01-0001               │
└──────────────────────────────┘

┌──────────────────────────────┐
│ ☐ 活動中心                    │
│   社區2樓活動中心             │
│   觀察區域                    │
│   g-26-01-0002               │
└──────────────────────────────┘
```

### 步驟 4: 勾選要設為通知點的接收器

**操作**：點擊接收器前面的勾選框

**效果**：
- ✓ 勾選框打勾
- 顯示「已設為通知點」綠色標籤
- 下方出現「自訂通知訊息」輸入框

```
┌──────────────────────────────┐
│ ☑ 社區大門                    │  ← 已勾選
│   台北市大安區XXX路           │
│   ✓ 已設為通知點              │  ← 綠色標籤
│                              │
│   自訂通知訊息（選填）         │
│   [長者經過社區大門_______] [更新]  ← 輸入框
│   留空則使用預設訊息...        │
└──────────────────────────────┘
```

### 步驟 5: 設定自訂通知訊息（選填）

**操作**：
1. 在輸入框輸入訊息，例如：「長者已安全回到社區」
2. 點擊「更新」按鈕

**效果**：
- 顯示「自訂訊息已更新」
- 訊息保存到資料庫

**如果不設定自訂訊息**：
- 系統使用預設格式：「[長者名稱] 經過 [接收器名稱]」

### 步驟 6: 停用通知點

**操作**：再次點擊勾選框取消勾選

**效果**：
- 勾選框取消
- 「已設為通知點」標籤消失
- 該接收器不再觸發通知

---

## 資料儲存位置

### Firestore 集合結構

當您勾選一個接收器時，系統會在 `tenantNotificationPoints` 集合建立記錄：

```javascript
// Collection: tenantNotificationPoints
{
  id: "auto_generated_id",
  tenantId: "您的社區ID",           // 自動帶入
  gatewayId: "gateway_123",         // 您勾選的 gateway
  name: "社區大門",                 // 從 gateway 複製
  notificationMessage: "長者經過社區大門",  // 您設定的自訂訊息
  notifyOnElderActivity: true,      // 固定為 true
  isActive: true,                   // 勾選=true，取消=false
  createdAt: "2026-01-25T...",
  updatedAt: "2026-01-25T..."
}
```

**重要**：
- 這個記錄是在**社區資料庫下**（不是 Admin 資料庫）
- 只有您社區的管理員可以管理
- 其他社區無法看到或修改

---

## 權限說明

### 誰可以操作？

**ADMIN 角色**：
- ✅ 勾選/取消勾選通知點
- ✅ 設定自訂訊息
- ✅ 更新訊息

**MEMBER 角色**：
- ✅ 查看哪些 gateway 是通知點
- ✅ 查看自訂訊息
- ❌ 無法勾選或修改

### 資料範圍限制

- 只能看到**自己社區的 gateways**
- 只能設定**自己社區的通知點**
- 無法看到或修改其他社區的設定

---

## 如果頁面沒有顯示接收器

### 原因 1: 社區沒有 Gateway

**症狀**：顯示「此社區暫無接收器」

**解決方法**：
需要先在 Admin 後台新增 Gateway（這個只需要做一次）：

1. 請系統管理員在 Admin 的「GateWay 管理」新增接收器
2. **重要**：設定「所屬社區」為您的社區
3. 完成後，重新整理 Community Portal

### 原因 2: Gateway 沒有設定所屬社區

**症狀**：Admin 有 Gateway，但 Community Portal 看不到

**解決方法**：
1. 在 Admin「GateWay 管理」編輯 Gateway
2. 設定「所屬社區」為您的社區
3. 儲存後重新整理

### 原因 3: 權限問題

**症狀**：Console 顯示權限錯誤

**解決方法**：
1. 確認您的帳號 `isActive` 為 true
2. 確認您的帳號有 `tenantId`
3. 重新登入

---

## 完整操作示範

### 情境：為「社區大門」設定通知點

1. **登入 Community Portal**
   - 訪問：`https://safe-net-tw.web.app/community`
   - 輸入您的 Email 和密碼

2. **前往通知點頁面**
   - 點擊側邊欄「通知點」

3. **查看接收器列表**
   - 應該看到您社區的所有接收器
   - 例如：「社區大門」、「活動中心」、「公園入口」等

4. **勾選「社區大門」**
   - 點擊「社區大門」前面的勾選框
   - 等待 1-2 秒（自動保存）
   - 看到「已設為通知點」標籤

5. **設定自訂訊息**
   - 在輸入框輸入：「長者已進入社區，請注意」
   - 點擊「更新」
   - 看到「自訂訊息已更新」

6. **完成！**
   - 現在當長者經過「社區大門」時
   - 系統會自動發送 LINE 通知給社區成員
   - 通知內容是：「長者已進入社區，請注意」

---

## 測試通知觸發

### 模擬長者經過通知點

**方法 1：請系統管理員協助**
- 在 Admin 的「Line 通知測試」頁面
- 輸入長者的設備資訊和通知點的 gateway
- 發送測試

**方法 2：使用實際設備**
- 讓長者攜帶的 Beacon 設備靠近「社區大門」的接收器
- 等待自動上傳

**預期結果**：
- LINE 收到通知
- 通知內容是您設定的自訂訊息
- Community Portal「通知記錄」出現記錄

---

## 與 Admin 的關係

| 操作 | 在哪裡做 | 誰來做 |
|------|---------|--------|
| 新增 Gateway（接收器） | Admin 後台 | 系統管理員 |
| 設定通知點（勾選） | Community Portal | 社區管理員 |
| 設定自訂訊息 | Community Portal | 社區管理員 |
| 查看通知記錄 | Community Portal | 社區管理員 |

**簡單來說**：
- **系統管理員**：在 Admin 建立實體接收器（一次性）
- **社區管理員**：在 Community Portal 決定哪些接收器要發通知（隨時調整）

---

## 設計理念

### 為什麼這樣設計？

1. **Gateway 管理**（Admin）
   - Gateway 是實體硬體設備
   - 需要設定序號、MAC、位置座標等技術資訊
   - 由系統管理員統一管理

2. **通知點設定**（Community Portal）
   - 通知點是邏輯概念（哪些位置要通知）
   - 社區管理員根據實際需求決定
   - 可以隨時調整，無需技術知識
   - 設定自訂訊息，符合社區需求

### 資料隔離

每個社區的通知點設定是**獨立的**：
- 社區 A 的管理員只能看到和設定社區 A 的通知點
- 社區 B 的管理員只能看到和設定社區 B 的通知點
- 資料完全隔離，互不影響

---

## 當前實作確認

### ✅ 功能已正確實作

1. **Gateway 查詢**：
   ```typescript
   // 只查詢該社區的 gateways
   where('tenantId', '==', tenantId)
   where('isActive', '==', true)
   ```

2. **通知點建立**：
   ```typescript
   // 勾選時建立記錄
   tenantNotificationPoints.add({
     tenantId: 當前社區ID,
     gatewayId: 勾選的gateway,
     // ...其他資訊
   })
   ```

3. **權限控制**：
   - 只有 ADMIN 角色可以勾選
   - MEMBER 角色只能查看

### ✅ 資料儲存正確

- 記錄在 `tenantNotificationPoints` 集合
- 包含 `tenantId` 欄位
- 其他社區無法存取

---

## 測試指南

### 本地測試

訪問：`http://localhost:3003/community/notification-points`

1. 登入後查看是否顯示 gateway 列表
2. 如果沒有，檢查：
   - 開啟 F12 查看 Console 錯誤
   - 確認社區有 gateway（tenantId 正確）

### 生產環境測試

訪問：`https://safe-net-tw.web.app/community/notification-points`

1. 登入
2. 勾選接收器
3. 設定訊息
4. 測試觸發

---

## 故障排除

### 問題：頁面顯示「此社區暫無接收器」

**原因**：該社區的 gateway 數量為 0

**解決方法**：

**選項 A：請系統管理員新增**
1. 聯絡系統管理員
2. 請他們在 Admin「GateWay 管理」新增接收器
3. **重要**：設定所屬社區為您的社區

**選項 B：檢查現有 Gateway**
1. 在 Firestore Console 查看 `gateways` 集合
2. 找到應該屬於您社區的 gateway
3. 確認 `tenantId` 欄位是否正確
4. 如果不正確，請系統管理員在 Admin 修改

### 問題：看得到 Gateway 但無法勾選

**原因**：您的角色是 MEMBER（不是 ADMIN）

**解決方法**：
請系統管理員在 Admin「SaaS 用戶管理」將您的角色改為 ADMIN

### 問題：勾選後沒有保存

**檢查**：
1. 開啟瀏覽器開發者工具（F12）
2. 查看 Console 是否有錯誤
3. 常見錯誤：
   - 權限不足 → 確認 Firestore Rules
   - 網路錯誤 → 檢查網路連線

---

## 資料流程圖

```
您在 Community Portal 勾選接收器
          ↓
在 Firestore 建立記錄
(tenantNotificationPoints 集合)
          ↓
長者經過該接收器
          ↓
Cloud Function 檢查是否為通知點
          ↓
發送 LINE 通知（含您的自訂訊息）
          ↓
顯示在「通知記錄」頁面
```

**完全在社區資料庫下操作，不影響其他社區！**

---

## 總結

### 您可以做什麼（在 Community Portal）

- ✅ 查看社區的所有接收器
- ✅ 勾選接收器設為通知點
- ✅ 設定自訂通知訊息
- ✅ 隨時啟用/停用通知點
- ✅ 查看哪些位置是通知點

### 您不需要做什麼

- ❌ 不需要訪問 Admin 後台
- ❌ 不需要請系統管理員設定通知點
- ❌ 不需要了解技術細節

### 系統管理員負責（在 Admin）

- 建立實體接收器（Gateway）
- 設定接收器的技術參數
- 將接收器分配給各社區

---

## 快速參考

**Community Portal URL**：
```
https://safe-net-tw.web.app/community
```

**通知點頁面**：
```
側邊欄 → 通知點
或直接訪問 /community/notification-points
```

**操作**：
1. 勾選 = 設為通知點
2. 取消勾選 = 停用通知點
3. 輸入訊息 + 更新 = 設定自訂訊息

---

## 實際使用範例

### 範例 1: 社區大門通知

1. 勾選「社區大門」接收器
2. 設定訊息：「長者已進入社區」
3. 當長者經過社區大門 → 發送通知

### 範例 2: 活動中心簽到

1. 勾選「活動中心」接收器
2. 設定訊息：「長者參加活動中心活動」
3. 當長者進入活動中心 → 發送通知

### 範例 3: 外出提醒

1. 勾選「社區大門」接收器
2. 設定訊息：「長者外出，請注意安全」
3. 當長者離開社區 → 發送通知

---

## 需要協助？

如果遇到問題：

1. **沒有顯示接收器**
   - 聯絡系統管理員，請他們在 Admin 新增 Gateway
   - 並設定所屬社區

2. **無法勾選**
   - 確認您的角色是 ADMIN
   - 聯絡系統管理員調整權限

3. **通知沒有觸發**
   - 參考 `TESTING_NOTIFICATION_POINTS.md` 的除錯指南
   - 聯絡技術人員檢查 Cloud Functions 日誌

---

這樣設計的好處是：社區管理員可以完全自主管理通知點，不需要依賴系統管理員或 IT 人員！
