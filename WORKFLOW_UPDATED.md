# 系統使用流程指南（更新版）

## 📋 完整工作流程

### 步驟 1: 設備採購與登記

**操作位置：** 設備管理頁面

1. 採購設備後，進入「設備管理」頁面
2. 點擊「新增設備」
3. 填寫設備資訊：
   - **UUID** (主要判定指標，必填)
   - MAC Address (輔助識別，選填)
   - 設備名稱
   - 設備類型 (iBeacon/Eddystone/Generic BLE)
   - Major/Minor (iBeacon 用)
   - 初始電量
4. **注意：** 此時不需要選擇社區或長者，設備會進入「設備池」

**資料狀態：**

```javascript
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  macAddress: "AA:BB:CC:DD:EE:FF",
  deviceName: "iBeacon #001",
  type: "IBEACON",
  tenantId: null,  // 未分配社區
  elderId: null,   // 未綁定長者
  isActive: true
}
```

### 步驟 2: 接收點設定

**操作位置：** 閘道器管理頁面

1. 進入「閘道器管理」頁面
2. 點擊「新增閘道器」
3. 填寫接收點資訊：
   - 序號 \*
   - 名稱 \*
   - 類型 \* (一般/邊界/移動)
   - 位置描述
   - GPS 座標 (固定式接收點)
   - **所在社區範圍（選填）** ⭐
4. **重要：** 接收點不需要分配社區，可接收所有設備訊號
5. **社區標記：** 僅用於標記接收點位置，方便管理

**資料狀態：**

```javascript
{
  serialNumber: "GW-001",
  name: "大門接收點",
  type: "BOUNDARY",
  location: "社區大門口",
  tenantId: "tenant_dalove_001",  // 選填：標記位置
  latitude: 25.033,
  longitude: 121.565,
  isActive: true
}
```

### 步驟 3: 社區管理 - 分配設備

**操作位置：** 社區管理頁面

#### 3.1 創建社區

1. 進入「社區管理」頁面
2. 點擊「新增社區」
3. 填寫社區資訊：
   - 社區代碼 (如: DALOVE001)
   - 社區名稱
   - 地址
   - 聯絡人
   - 聯絡電話

#### 3.2 分配設備到社區

1. 在社區列表中，找到目標社區
2. 點擊「設備管理」圖示（📱）
3. 在彈出視窗中：
   - 看到該社區已分配的設備
   - 從「設備池」選擇要分配的設備
   - 點擊「分配」
4. 設備現在屬於該社區，可以綁定給長者使用

**資料變化：**

```javascript
// 設備資料更新
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  tenantId: "tenant_dalove_001",  // ✓ 已分配到社區
  elderId: null,                   // 尚未綁定長者
}
```

### 步驟 4: 長者管理 - 綁定設備

**操作位置：** 長者管理頁面

1. 進入「長者管理」頁面
2. 點擊「新增長者」或編輯現有長者
3. 填寫長者基本資訊：
   - 所屬社區 (先選擇社區)
   - 姓名
   - 電話
   - 地址
   - 緊急聯絡人
   - 狀態 (活躍/非活躍/住院等)
   - 不活躍閾值 (小時)
4. **選擇設備：**
   - 在設備下拉選單中，只會顯示：
     - ✓ 已分配到該社區的設備
     - ✓ 且尚未綁定其他長者的設備
   - 選擇一個設備綁定給該長者

**資料最終狀態：**

```javascript
// 設備
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  tenantId: "tenant_dalove_001",  // ✓ 屬於大愛社區
  elderId: "elder_wang_001",       // ✓ 綁定給王奶奶
}

// 長者
{
  name: "王奶奶",
  tenantId: "tenant_dalove_001",
  device: {
    uuid: "550e8400-e29b-41d4-a716-446655440000",
    deviceName: "iBeacon #001"
  }
}
```

## 🔍 資源管理邏輯對比

### 設備管理（強制流程）

```
設備池 → 分配到社區 → 綁定長者
  ↓         ↓          ↓
 全域     社區級     個人級
```

**特點：**

- ✅ 必須先分配到社區
- ✅ 才能綁定給該社區的長者
- ✅ 一個設備只能屬於一個社區
- ✅ 一個設備只能綁定一位長者

### 接收點管理（位置標記）

```
接收點登記 → 可選標記社區（非強制）
     ↓              ↓
   全域接收      位置標記
```

**特點：**

- ✅ 不需要分配社區
- ✅ 可接收所有設備訊號
- ✅ tenantId 僅用於標記位置
- ✅ 方便管理和識別接收點位置

## 📊 完整資料流程圖

```
┌─────────────────┐
│  1. 採購設備     │
│  UUID 登記      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  設備池         │
│ tenantId: null  │
│ elderId: null   │
└────────┬────────┘
         │
         │ 社區管理員分配
         ▼
┌─────────────────┐
│  社區設備庫     │
│ tenantId: xxx   │
│ elderId: null   │
└────────┬────────┘
         │
         │ 綁定給長者
         ▼
┌─────────────────┐
│  長者設備       │
│ tenantId: xxx   │
│ elderId: yyy    │
└─────────────────┘


┌─────────────────┐
│  2. 設定接收點   │
│  序號/位置登記  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  接收點         │
│ tenantId: xxx   │ ← 選填：標記位置
│ (可接收所有訊號) │
└─────────────────┘
```

## 🎯 關鍵設計原則

### 1. UUID 為主要判定指標

- ✅ 使用 `uuid` 識別設備
- ✅ `getByUuid()` 查詢設備
- ℹ️ `macAddress` 僅作為輔助識別

### 2. 設備：三層資源管理

```
設備池 → 社區資源 → 長者綁定
  ↓         ↓          ↓
 全域     社區級     個人級
```

### 3. 接收點：全域接收 + 位置標記

```
接收點登記 → 選填社區標記
     ↓            ↓
 接收所有訊號   位置管理
```

### 4. 資源狀態流轉

**設備狀態：**

- **未分配** → 在設備池中，可分配給任何社區
- **已分配** → 屬於特定社區，可綁定給該社區的長者
- **已綁定** → 正在被特定長者使用

**接收點狀態：**

- **已登記** → 可接收所有設備訊號
- **標記社區** → 便於識別接收點位置（不影響功能）

### 5. 權限控制

- **超級管理員：** 可管理設備池、所有社區、所有接收點
- **社區管理員：** 只能管理自己社區的設備和長者
- **一般員工：** 查看權限

## 使用建議

### 設備命名規範

```
設備名稱：[類型]-[編號]
範例：iBeacon-001, Eddystone-A01
```

### UUID 格式

```
標準 UUID v4 格式：
550e8400-e29b-41d4-a716-446655440000
```

### 接收點命名規範

```
序列號：[類型]-[社區簡稱]-[編號]
範例：GW-DALOVE-001, MOBILE-IPHONE-A3K9F2

名稱：[位置描述]
範例：社區大門、活動中心、志工手機
```

### 社區代碼規範

```
[社區簡稱][流水號]
範例：DALOVE001, SUNRISE002
```

## 🔄 常見操作流程

### 設備回收/重新分配

1. 編輯長者資料，解除設備綁定（elderId → null）
2. 設備回到「社區可用設備」
3. 可分配給該社區的其他長者

### 設備轉移社區

1. 解除設備與長者的綁定
2. 在社區管理中移除設備（tenantId → null）
3. 設備回到設備池
4. 重新分配到新社區

### 接收點位置更新

1. 編輯接收點資料
2. 更新 tenantId（社區標記）
3. 不影響接收功能

### 移動式接收點

1. 類型選擇「移動接收點」
2. 不需要填寫 GPS 座標
3. 可選擇標記主要活動社區

## ⚠️ 注意事項

### 設備管理

1. **UUID 必須唯一** - 系統會檢查重複
2. **先分配社區才能綁定長者** - 資料流程不可跳過
3. **設備只能同時綁定一位長者** - 一對一關係

### 接收點管理

1. **接收點不需要分配社區** - 可接收所有設備訊號
2. **社區標記僅用於位置管理** - 不影響接收功能
3. **移動式接收點** - 不需要 GPS 座標
4. **邊界點** - 觸發警報功能
5. **一般接收點** - 記錄活動軌跡

### 即時監聽

- 所有操作即時更新，多人協作安全

## 🎓 培訓檢查清單

- [ ] 了解設備登記流程（UUID為主）
- [ ] 了解社區資源分配流程（設備必須分配）
- [ ] 了解長者設備綁定流程
- [ ] 了解接收點登記流程（不需分配社區）
- [ ] 了解接收點社區標記用途（僅位置管理）
- [ ] 知道如何回收/重新分配設備
- [ ] 知道如何查詢設備狀態
- [ ] 了解權限範圍（超管 vs 社區管理員）

## 🔍 常見問題

### Q: 接收點為什麼不需要分配社區？

A: 接收點是訊號接收設備，可以接收所有設備的訊號。標記社區只是為了方便管理和識別接收點位置。

### Q: 接收點的社區標記有什麼用？

A: 僅用於位置管理，例如：

- 「大愛社區大門接收點」標記為大愛社區
- 「活動中心接收點」標記為對應社區
- 方便查詢某社區範圍內有哪些接收點

### Q: 移動式接收點如何使用？

A: 移動式接收點（如志工手機）不需要固定位置，可以：

- 不填寫 GPS 座標
- 可選擇標記主要活動社區
- 接收所有設備訊號

### Q: 設備和接收點的差異？

A:

- **設備**：綁定在長者身上，必須分配到社區
- **接收點**：固定或移動的接收器，不需要分配社區

---

**此流程設計完全符合您的使用邏輯！** 🎉
