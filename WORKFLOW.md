# 系統使用流程指南

## 📋 完整工作流程

### 步驟 1: 設備採購與登記

**操作位置：** 設備管理頁面

1. 採購設備後，進入「設備管理」頁面
2. 點擊「新增設備」
3. 填寫設備資訊：
   - **UUID** (主要判定指標，必填)
   - MAC Address (輔助識別)
   - 設備名稱
   - 設備類型 (iBeacon/Eddystone/Generic BLE)
   - Major/Minor (iBeacon 用)
   - 初始電量
4. **注意：** 此時不需要選擇社區或長者，設備會進入「設備池」

**資料狀態：**

```javascript
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  macAddress: "AA:BB:CC:DD:EE:FF",
  deviceName: "iBeacon #001",
  type: "IBEACON",
  tenantId: null,  // 未分配社區
  elderId: null,   // 未綁定長者
  isActive: true
}
```

### 步驟 2: 接收點設定

**操作位置：** 閘道器管理頁面

1. 進入「閘道器管理」頁面
2. 點擊「新增閘道器」
3. 填寫接收點資訊：
   - 序號
   - 名稱
   - 類型 (一般/邊界/移動)
   - 位置描述
   - GPS 座標 (選填)
4. **注意：** 此時不需要選擇社區，接收點可以稍後分配

**資料狀態：**

```javascript
{
  serialNumber: "GW-001",
  name: "大門接收點",
  type: "BOUNDARY",
  location: "社區大門口",
  tenantId: null,  // 未分配社區
  isActive: true
}
```

### 步驟 3: Line OA 管理 - 分配資源

**操作位置：** Line OA 管理頁面

#### 3.1 創建社區

1. 進入「Line OA 管理」頁面
2. 點擊「新增社區」
3. 填寫社區資訊：
   - 社區代碼 (如: DALOVE001)
   - 社區名稱
   - 地址
   - 聯絡人
   - 聯絡電話

#### 3.2 分配設備到社區

1. 在社區列表中，找到目標社區
2. 點擊「設備管理」圖示（📱）
3. 在彈出視窗中：
   - 看到該社區已分配的設備
   - 從「設備池」選擇要分配的設備
   - 點擊「分配」
4. 設備現在屬於該社區，可以綁定給長者使用

**資料變化：**

```javascript
// 設備資料更新
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  tenantId: "tenant_dalove_001",  // ✓ 已分配到社區
  elderId: null,                   // 尚未綁定長者
}
```

#### 3.3 分配接收點到社區

1. 同樣在「閘道器管理」中
2. 創建閘道器時選擇所屬社區
3. 或編輯現有閘道器，指定社區

### 步驟 4: 長者管理 - 綁定設備

**操作位置：** 長者管理頁面

1. 進入「長者管理」頁面
2. 點擊「新增長者」或編輯現有長者
3. 填寫長者基本資訊：
   - 所屬社區 (先選擇社區)
   - 姓名
   - 電話
   - 地址
   - 緊急聯絡人
   - 狀態 (活躍/非活躍/住院等)
   - 不活躍閾值 (小時)
4. **選擇設備：**
   - 在設備下拉選單中，只會顯示：
     - ✓ 已分配到該社區的設備
     - ✓ 且尚未綁定其他長者的設備
   - 選擇一個設備綁定給該長者

**資料最終狀態：**

```javascript
// 設備
{
  uuid: "550e8400-e29b-41d4-a716-446655440000",
  tenantId: "tenant_dalove_001",  // ✓ 屬於大愛社區
  elderId: "elder_wang_001",       // ✓ 綁定給王奶奶
}

// 長者
{
  name: "王奶奶",
  tenantId: "tenant_dalove_001",
  device: {
    uuid: "550e8400-e29b-41d4-a716-446655440000",
    deviceName: "iBeacon #001"
  }
}
```

## 🔍 資源查詢邏輯

### 設備查詢

#### 1. 設備池（未分配設備）

```javascript
// 顯示所有 tenantId === null 的設備
deviceService.getUnassignedDevices();
```

**用於：** Line OA 管理員分配設備到社區

#### 2. 社區可用設備（已分配但未綁定）

```javascript
// tenantId === 'xxx' AND elderId === null
deviceService.getAvailableDevicesInTenant(tenantId);
```

**用於：** 長者管理中選擇設備

#### 3. 設備唯一性驗證（使用 UUID）

```javascript
// 主要判定指標
deviceService.getByUuid(uuid);
```

**用於：**

- 防止重複登記
- 設備識別
- 資料同步

## 📊 完整資料流程圖

```
┌─────────────────┐
│  1. 採購設備     │
│  UUID 登記      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  設備池         │
│ tenantId: null  │
│ elderId: null   │
└────────┬────────┘
         │
         │ Line OA 管理員分配
         ▼
┌─────────────────┐
│  社區設備庫     │
│ tenantId: xxx   │
│ elderId: null   │
└────────┬────────┘
         │
         │ 綁定給長者
         ▼
┌─────────────────┐
│  長者設備       │
│ tenantId: xxx   │
│ elderId: yyy    │
└─────────────────┘
```

## 🎯 關鍵設計原則

### 1. UUID 為主要判定指標

- ✅ 使用 `uuid` 識別設備
- ✅ `getByUuid()` 查詢設備
- ℹ️ `macAddress` 僅作為輔助識別

### 2. 三層資源管理

```
設備池 → 社區資源 → 長者綁定
  ↓         ↓          ↓
 全域     社區級     個人級
```

### 3. 資源狀態流轉

- **未分配** → 在設備池中，可分配給任何社區
- **已分配** → 屬於特定社區，可綁定給該社區的長者
- **已綁定** → 正在被特定長者使用

### 4. 權限控制

- **超級管理員：** 可管理設備池、所有社區
- **Line OA 管理員：** 只能管理自己社區的資源
- **一般員工：** 查看權限

## 使用建議

### 設備命名規範

```
設備名稱：[類型]-[編號]
範例：iBeacon-001, Eddystone-A01
```

### UUID 格式

```
標準 UUID v4 格式：
550e8400-e29b-41d4-a716-446655440000
```

### 社區代碼規範

```
[社區簡稱][流水號]
範例：DALOVE001, SUNRISE002
```

## 🔄 常見操作流程

### 設備回收/重新分配

1. 編輯長者資料，解除設備綁定（elderId → null）
2. 設備回到「社區可用設備」
3. 可分配給該社區的其他長者

### 設備轉移社區

1. 解除設備與長者的綁定
2. 在Line OA 管理中移除設備（tenantId → null）
3. 設備回到設備池
4. 重新分配到新社區

### 社區關閉/遷移

1. 解除所有長者的設備綁定
2. 批量移除社區的所有設備
3. 設備回到設備池可重新分配

## ⚠️ 注意事項

1. **UUID 必須唯一** - 系統會檢查重複
2. **先分配社區才能綁定長者** - 資料流程不可跳過
3. **設備只能同時綁定一位長者** - 一對一關係
4. **接收點可以不綁定社區** - 移動式接收點使用
5. **即時監聽** - 所有操作即時更新，多人協作安全

## 🎓 培訓檢查清單

- [ ] 了解設備登記流程（UUID為主）
- [ ] 了解社區資源分配流程
- [ ] 了解長者設備綁定流程
- [ ] 知道如何回收/重新分配設備
- [ ] 知道如何查詢設備狀態
- [ ] 了解權限範圍（超管 vs Line OA 管理員）

---

**此流程設計完全符合您的使用邏輯！** 🎉
