rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 開發模式 - 允許所有讀寫（僅用於開發測試）
    match /{document=**} {
      allow read, write: if true;
    }
  }
}

// 生產環境規則（待啟用）
/*
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 輔助函數
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'SUPER_ADMIN';
    }
    
    function isTenantAdmin() {
      return isAuthenticated() && getUserData().role == 'TENANT_ADMIN';
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserData().tenantId == tenantId;
    }
    
    // Admin Users 集合
    match /admin_users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    // Tenants 集合
    match /tenants/{tenantId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
      
      // 子集合：成員
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow write: if isSuperAdmin() || (isTenantAdmin() && belongsToTenant(tenantId));
      }
    }
    
    // Elders 集合
    match /elders/{elderId} {
      allow read: if isAuthenticated();
      allow create: if isSuperAdmin() || isTenantAdmin();
      allow update, delete: if isSuperAdmin() || (isTenantAdmin() && belongsToTenant(resource.data.tenantId));
      
      // 子集合：活動記錄
      match /activities/{activityId} {
        allow read: if isAuthenticated();
        allow write: if isSuperAdmin() || isTenantAdmin();
      }
      
      // 子集合：位置記錄
      match /locations/{locationId} {
        allow read: if isAuthenticated();
        allow write: if isSuperAdmin() || isTenantAdmin();
      }
    }
    
    // Devices 集合
    match /devices/{deviceId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // Gateways 集合
    match /gateways/{gatewayId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // Alerts 集合
    match /alerts/{alertId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // Line Users 集合
    match /line_users/{lineUserId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // App Users 集合（Line 用戶管理）
    match /app_users/{appUserId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // AppUserNotificationPoints 集合（用戶通知點位）
    match /appUserNotificationPoints/{pointId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // UUIDs 集合
    match /uuids/{uuidId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin() || isTenantAdmin();
    }
    
    // ========================================
    // Community Portal Rules (SaaS Users)
    // ========================================
    
    // 輔助函數：獲取 SaaS 用戶資料
    function getSaasUserData() {
      return get(/databases/$(database)/documents/saas_users/$(request.auth.uid)).data;
    }
    
    // 輔助函數：檢查是否為 SaaS 用戶
    function isSaasUser() {
      return isAuthenticated() && exists(/databases/$(database)/documents/saas_users/$(request.auth.uid));
    }
    
    // 輔助函數：檢查是否為 SaaS 管理員
    function isSaasUserAdmin() {
      return isSaasUser() && getSaasUserData().role == 'ADMIN' && getSaasUserData().isActive == true;
    }
    
    // 輔助函數：獲取用戶的社區 ID
    function getSaasUserTenantId() {
      return getSaasUserData().tenantId;
    }
    
    // 輔助函數：檢查資源是否屬於用戶的社區
    function belongsToSaasUserTenant(resourceTenantId) {
      return isSaasUser() && getSaasUserTenantId() == resourceTenantId;
    }
    
    // SaaS Users 集合（Line OA 管理員用戶）
    match /saas_users/{userId} {
      // 只能讀取自己的記錄（文件 ID = Firebase UID）
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // 只能由超級管理員建立和修改
      allow write: if isSuperAdmin();
    }
    
    // Elders 集合（SaaS 用戶權限）
    match /elders/{elderId} {
      allow read: if isSaasUser() && belongsToSaasUserTenant(resource.data.tenantId);
      allow create: if isSaasUserAdmin() && belongsToSaasUserTenant(request.resource.data.tenantId);
      allow update, delete: if isSaasUserAdmin() && belongsToSaasUserTenant(resource.data.tenantId);
    }
    
    // Devices 集合（SaaS 用戶只讀權限）
    match /devices/{deviceId} {
      // 只能查看標記為所屬社區的設備
      allow read: if isSaasUser() && 
        ('tenant_' + getSaasUserTenantId()) in resource.data.tags;
      // SaaS 用戶不能修改設備（只有超級管理員可以）
      allow write: if isSuperAdmin();
    }
    
    // Tenant Notification Points 集合（社區通知點）
    match /tenantNotificationPoints/{pointId} {
      // 只能讀取自己社區的通知點
      allow read: if isSaasUser() && 
        belongsToSaasUserTenant(resource.data.tenantId);
      // 只有管理員可以新增通知點
      allow create: if isSaasUserAdmin() && 
        belongsToSaasUserTenant(request.resource.data.tenantId);
      // 只有管理員可以修改和刪除通知點
      allow update, delete: if isSaasUserAdmin() && 
        belongsToSaasUserTenant(resource.data.tenantId);
    }
    
    // Gateways 集合（SaaS 用戶權限）
    match /gateways/{gatewayId} {
      // 可以讀取所屬社區的 gateways（用於選擇通知點）
      allow read: if isSaasUser() && 
        (resource.data.tenantId == getSaasUserTenantId() || resource.data.tenantId == null);
      // 不能修改 gateways
      allow write: if isSuperAdmin();
    }
  }
}
*/
