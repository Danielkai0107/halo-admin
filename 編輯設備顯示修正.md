# 編輯長者時設備顯示修正

## 問題描述

編輯長者時，設備下拉選單沒有顯示當前綁定的設備。

## 問題原因

### 查詢邏輯問題

`elderService.getAvailableDevices` 只查詢未綁定的設備：

```typescript
where('bindingType', '==', 'UNBOUND')
```

但長者當前綁定的設備狀態是：
```typescript
bindingType: 'ELDER'
boundTo: '該長者ID'
```

**結果**：當前設備不在查詢結果中 → 下拉選單沒有當前設備選項

---

## 解決方案

### 修正邏輯

在編輯模式時，如果長者有綁定設備，手動添加到設備列表：

```typescript
const loadAvailableDevices = async () => {
  // 1. 查詢未綁定的設備
  const response = await elderService.getAvailableDevices(tenantId);
  let devices = response.data;
  
  // 2. 如果是編輯模式且有綁定設備
  if (editingElder && editingElder.device) {
    const currentDevice = editingElder.device;
    const currentDeviceInList = devices.find(d => d.id === currentDevice.id);
    
    // 3. 如果當前設備不在列表中，添加進去
    if (!currentDeviceInList) {
      devices = [currentDevice, ...devices];
    }
  }
  
  setAvailableDevices(devices);
};
```

### 顯示標示

在下拉選單中標示當前設備：

```typescript
<option value={device.id}>
  設備名稱 | UUID: ... | Major/Minor
  {device.id === editingElder?.deviceId ? ' (當前)' : ''}
</option>
```

---

## 修正後的行為

### 新增模式

**設備列表**：
- 該社區所有未綁定的設備
- bindingType = 'UNBOUND'

**下拉選單**：
```
不綁定設備
設備 101 | UUID: FDA50693... | 1/101
設備 102 | UUID: FDA50693... | 1/102
設備 103 | UUID: FDA50693... | 1/103
```

---

### 編輯模式

**設備列表**：
- 該社區所有未綁定的設備
- **加上當前綁定的設備**（如果有）

**下拉選單**：
```
不綁定設備
設備 100 | UUID: FDA50693... | 1/100 (當前) ← 當前綁定的設備
設備 101 | UUID: FDA50693... | 1/101        ← 可選的其他設備
設備 102 | UUID: FDA50693... | 1/102
設備 103 | UUID: FDA50693... | 1/103
```

**選項說明**：
- 保持當前設備 → 選擇「設備 100 (當前)」
- 變更設備 → 選擇其他設備
- 解綁設備 → 選擇「不綁定設備」

---

## 測試步驟

### 1. 確認長者有綁定設備

在長者列表或詳情頁面確認有設備資訊。

### 2. 開啟編輯 Modal

**方式 A**：滑鼠移到卡片 → 點擊編輯按鈕
**方式 B**：詳情頁面 → 點擊編輯按鈕

### 3. 檢查設備下拉選單

**應該看到**：
- [ ] 「不綁定設備」選項
- [ ] **當前綁定的設備（標示「當前」）** ← 修正後應該出現
- [ ] 其他可用設備（如果有）

**當前設備應該被選中**：
- 下拉選單預設值 = 當前設備 ID
- 顯示設備名稱和「(當前)」標示

### 4. 測試變更設備

**情況 A：保持當前設備**
- 不改變下拉選單
- 提交 → 設備綁定不變

**情況 B：變更到其他設備**
- 選擇其他設備
- 提交 → 舊設備解綁，新設備綁定

**情況 C：解除綁定**
- 選擇「不綁定設備」
- 提交 → 當前設備解綁

---

## 設備綁定變更邏輯

### 編輯提交時的處理

```typescript
// 比較舊設備和新設備
const oldDeviceId = editingElder.deviceId;    // 原本的設備 ID
const newDeviceId = formData.deviceId;        // 表單選擇的設備 ID

if (oldDeviceId !== newDeviceId) {
  // 設備有變更
  
  if (oldDeviceId) {
    // 解綁舊設備
    await elderService.unbindDevice(elderId, oldDeviceId);
  }
  
  if (newDeviceId) {
    // 綁定新設備
    await elderService.bindDevice(elderId, newDeviceId);
  }
}
```

### 三種情況處理

**1. 從設備 A → 設備 B**
```
oldDeviceId = 'device_A'
newDeviceId = 'device_B'
→ 解綁 A，綁定 B
```

**2. 從有設備 → 無設備**
```
oldDeviceId = 'device_A'
newDeviceId = ''
→ 解綁 A
```

**3. 從無設備 → 有設備**
```
oldDeviceId = ''
newDeviceId = 'device_B'
→ 綁定 B
```

**4. 保持不變**
```
oldDeviceId = 'device_A'
newDeviceId = 'device_A'
→ 不做任何操作
```

---

## 修正的檔案

**檔案**：`community-portal/src/components/ElderFormModal.tsx`

**修改內容**：
1. `loadAvailableDevices` 方法
   - 添加檢查當前設備的邏輯
   - 如果當前設備不在列表，手動添加

2. 設備選項顯示
   - 添加「(當前)」標示

---

## 部署狀態

✅ 編譯成功

正在部署到生產環境...
