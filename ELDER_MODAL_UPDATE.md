# 長者管理功能更新

## 更新日期
2026-01-25 22:35

## 更新內容

### 1. 新增長者改為 Popup Modal

**變更前**：
- 點擊「新增長者」→ 導航到獨立頁面 `/elders/add`
- 填寫表單 → 提交 → 導航到詳情頁面

**變更後**：
- 點擊「新增長者」→ 開啟 Modal 彈窗
- 填寫表單 → 提交 → Modal 關閉，列表自動更新
- 無需離開當前頁面

**優勢**：
- 更快的操作流程
- 不會失去列表的瀏覽位置
- 更好的用戶體驗

---

### 2. 新增時可選擇設備綁定

**新功能**：
在新增長者的 Modal 中添加「綁定設備」下拉選單

**顯示內容**：
```
綁定設備（選填）          [重新整理]
┌─────────────────────────────────┐
│ 不綁定設備                       │
│ 社區設備-001 | UUID: FDA50693... | 1/101 | 電量: 85% │
│ 社區設備-002 | UUID: FDA50693... | 1/102 | 電量: 90% │
│ 設備 103 | UUID: FDA50693... | 1/103 │
└─────────────────────────────────┘
```

**查詢條件**：
- tags 包含該社區 ID
- bindingType = 'UNBOUND'（未綁定）
- isActive = true（啟用）

**提交流程**：
1. 建立長者記錄
2. 如果選擇了設備 → 自動綁定
3. 完成（一次搞定）

---

### 3. 快速編輯功能

**新增編輯入口**：

**方式 1：長者列表卡片**
- 滑鼠移到長者卡片
- 右上角出現「編輯」按鈕
- 點擊 → 開啟編輯 Modal

**方式 2：長者詳情頁面**
- 點擊頂部「編輯」按鈕
- 開啟編輯 Modal

**編輯 Modal 功能**：
- 顯示所有現有資料
- 可以修改任何欄位
- **可以變更綁定的設備**
  - 解綁舊設備
  - 綁定新設備
  - 或從有設備改為無設備
- 提交 → 更新成功 → Modal 關閉

---

## 新建的檔案

### 1. Modal.tsx
通用 Modal 元件

**位置**：`community-portal/src/components/Modal.tsx`

**特點**：
- 支援不同大小（sm/md/lg/xl）
- 背景遮罩點擊關閉
- 右上角 X 按鈕
- 內容區域可滾動

### 2. ElderFormModal.tsx
長者新增/編輯表單 Modal

**位置**：`community-portal/src/components/ElderFormModal.tsx`

**功能**：
- 新增模式：空白表單
- 編輯模式：預填現有資料
- 設備選擇下拉選單
- 自動綁定/解綁設備
- 表單驗證

---

## 修改的檔案

### 1. ElderListScreen.tsx
**變更**：
- 添加 Modal 狀態管理
- 「新增長者」按鈕改為開啟 Modal
- 長者卡片添加快速編輯按鈕
- 移除導航到 `/elders/add`

### 2. ElderDetailScreen.tsx
**變更**：
- 「編輯」按鈕改為開啟 Modal
- 添加編輯成功回調
- 移除導航到編輯頁面

### 3. App.tsx
**變更**：
- 移除 `/elders/add` 路由
- 移除 AddElderScreen import

---

## 刪除的檔案

### AddElderScreen.tsx
原本的獨立新增頁面，已整合到 Modal 中，不再需要。

---

## UI 流程對比

### 新增長者流程

**舊流程**：
```
長者列表 → 點擊新增 → 導航到新增頁面 
→ 填寫表單 → 提交 → 導航到詳情頁面 
→ 點擊綁定設備 → 選擇設備 → 綁定
（3 個頁面切換）
```

**新流程**：
```
長者列表 → 點擊新增 → 開啟 Modal 
→ 填寫表單 + 選擇設備 → 提交 → Modal 關閉
→ 列表更新，顯示新長者
（留在原頁面，1 步完成）
```

### 編輯長者流程

**舊流程**：
```
長者列表 → 點擊長者 → 詳情頁面 
→ 點擊編輯 → 導航到編輯頁面（不存在）
```

**新流程**：
```
方式 A：
長者列表 → 滑鼠移到卡片 → 點擊編輯按鈕 → 開啟 Modal 
→ 修改資料 → 提交 → 完成

方式 B：
長者列表 → 點擊長者 → 詳情頁面 → 點擊編輯 
→ 開啟 Modal → 修改資料 → 提交 → 完成
```

---

## 功能詳細說明

### 設備選擇功能

**可用設備來源**：
```typescript
elderService.getAvailableDevices(tenantId)
```

**查詢條件**：
- `tags` 陣列包含該社區 ID
- `bindingType` 為 'UNBOUND'
- `isActive` 為 true

**顯示格式**：
```
設備名稱 | UUID: 前8碼... | Major/Minor | 電量: X%
```

**重新整理按鈕**：
- 點擊重新載入可用設備列表
- 防止設備狀態過時

---

### 設備綁定邏輯

**新增模式**：
```
1. 建立長者記錄（無 deviceId）
2. 如果選擇了設備 ID：
   a. 調用 elderService.bindDevice()
   b. 更新長者的 deviceId
   c. 更新設備的 bindingType 和 boundTo
```

**編輯模式**：
```
1. 比較舊設備 ID 和新設備 ID
2. 如果不同：
   a. 解綁舊設備（如果有）
   b. 綁定新設備（如果有）
3. 更新長者其他資料
```

---

## 測試步驟

### 測試 1: 新增長者（不綁定設備）

1. 訪問：`https://safe-net-tw.web.app/community/elders`
2. 點擊「新增長者」
3. **驗證**：開啟 Modal（不是新頁面）
4. 填寫姓名等基本資料
5. 設備選擇保持「不綁定設備」
6. 點擊「新增」
7. **驗證**：
   - [ ] Modal 關閉
   - [ ] 長者出現在列表中
   - [ ] 無設備綁定

### 測試 2: 新增長者（綁定設備）

1. 點擊「新增長者」
2. 填寫基本資料
3. **在設備下拉選單選擇一個設備**
4. **驗證**：看到設備選項（如果有可用設備）
5. 點擊「新增」
6. **驗證**：
   - [ ] Modal 關閉
   - [ ] 長者出現在列表中
   - [ ] 點擊長者查看詳情
   - [ ] 「綁定設備」區塊顯示設備資訊

### 測試 3: 快速編輯（從列表）

1. 滑鼠移到長者卡片
2. **驗證**：右上角出現編輯按鈕
3. 點擊編輯按鈕
4. **驗證**：
   - [ ] 開啟 Modal
   - [ ] 顯示現有資料
   - [ ] 設備下拉選單顯示當前綁定的設備
5. 修改姓名或其他資料
6. 點擊「更新」
7. **驗證**：
   - [ ] Modal 關閉
   - [ ] 卡片顯示更新後的資料

### 測試 4: 編輯設備綁定

1. 開啟編輯 Modal
2. 在設備下拉選單選擇不同的設備
3. 點擊「更新」
4. **驗證**：
   - [ ] 舊設備解綁成功
   - [ ] 新設備綁定成功
   - [ ] 長者詳情顯示新設備

### 測試 5: 從詳情頁面編輯

1. 點擊長者卡片進入詳情
2. 點擊頂部「編輯」按鈕
3. **驗證**：開啟編輯 Modal
4. 修改資料並提交
5. **驗證**：
   - [ ] Modal 關閉
   - [ ] 詳情頁面顯示更新後的資料

---

## 設備選擇注意事項

### 沒有可用設備時

**顯示**：
```
綁定設備（選填）
┌─────────────────────────────────┐
│ 不綁定設備                       │
└─────────────────────────────────┘
目前沒有可用的設備
```

**建議提示**：
- 「請先在設備清單確認是否有未綁定的設備」
- 「或聯絡系統管理員新增設備」

### 有可用設備時

**顯示**：
```
綁定設備（選填）          [重新整理]
┌─────────────────────────────────┐
│ 不綁定設備                       │
│ （3 個設備選項）                 │
└─────────────────────────────────┘
3 個可用設備
```

---

## 編譯狀態

✅ **編譯成功**

輸出文件：
- index.html: 0.49 kB
- CSS: 27.71 kB
- JS: 659.75 kB (gzip: 203.13 kB)

---

## 部署中...

正在部署到 Firebase Hosting...
