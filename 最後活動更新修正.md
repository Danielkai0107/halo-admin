# 最後活動時間更新修正

## 問題描述

長輩 Table 的「最後活動」欄位沒有更新，即使 LINE 已收到通知。

---

## 問題原因

### Cloud Functions 沒有更新長者的 lastActivityAt

**receiveBeaconData 函數流程**（修正前）：
```
1. 找到設備
2. 更新設備狀態（lastSeen, lastRssi, batteryLevel）
3. 處理通知
4. 記錄活動到 devices/{id}/activities
5. ❌ 沒有更新長者的 lastActivityAt
```

**結果**：
- 設備有活動記錄 ✅
- 設備的 lastSeen 更新 ✅
- **長者的 lastActivityAt 沒更新** ❌
- Table 顯示「無記錄」❌

---

## 解決方案

### 添加更新長者 lastActivityAt 的邏輯

**位置**：`functions/src/beacon/receiveBeaconData.ts`（第 1125 行後）

**新增邏輯**：
```typescript
// 4. Update elder's lastActivityAt if device is bound to elder
if (device.bindingType === 'ELDER' && device.boundTo) {
  try {
    await db.collection('elders').doc(device.boundTo).update({
      lastActivityAt: new Date(timestamp).toISOString(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    });
    console.log(`Updated elder ${device.boundTo} lastActivityAt`);
  } catch (error) {
    console.error(`Failed to update elder lastActivityAt:`, error);
  }
}
```

---

## 修正後的流程

```
1. 找到設備
   ↓
2. 更新設備狀態
   ↓
3. 處理通知（發送 LINE）
   ↓
4. ✅ 更新長者的 lastActivityAt（新增）
   ↓
5. 記錄活動到 devices/activities
```

---

## 更新的欄位

### elders 集合

```javascript
{
  id: "elder_001",
  name: "王小明",
  deviceId: "device_101",
  lastActivityAt: "2026-01-25T14:30:00.000Z",  // ← 會被更新
  updatedAt: Timestamp                          // ← 會被更新
}
```

### 何時更新？

**每次設備有活動時**：
1. 設備上傳資料到 receiveBeaconData
2. 設備綁定給長者（bindingType = 'ELDER'）
3. 更新該長者的 lastActivityAt
4. 使用設備活動的時間戳記

---

## Table 顯示

### 修正前

```
最後活動欄位：無記錄（灰色）
```

即使設備剛有活動，因為 lastActivityAt 沒更新。

### 修正後

```
最後活動欄位：
- 5分鐘前
- 2小時前
- 1天前
```

根據實際活動時間顯示。

---

## 即時更新

### 資料流

```
設備上傳資料
  ↓
Cloud Function 更新長者 lastActivityAt
  ↓
Firestore 觸發 elders 集合變更
  ↓
Community Portal 的 elderService.subscribe 接收更新
  ↓
Table 重新渲染
  ↓
「最後活動」欄位更新
```

**完全即時，無需重新整理！**

---

## 部署狀態

✅ 已部署完成

部署時間：2026-01-25 22:59

---

## 測試步驟

### 1. 發送測試資料

在 Admin「Line 通知測試」：
1. 選擇長者的設備（UUID/Major/Minor）
2. 選擇任一 gateway
3. 點擊「發送測試資料」

### 2. 查看長者列表

訪問：`https://safe-net-tw.web.app/community/elders`

**驗證「最後活動」欄位**：
- [ ] 顯示時間（如「5分鐘前」）
- [ ] 不再顯示「無記錄」
- [ ] 帶時鐘圖示

### 3. 再次發送測試

再發送一次測試資料

**驗證**：
- [ ] 「最後活動」時間更新
- [ ] 顯示「剛才」或「1分鐘前」
- [ ] 即時更新，無需重新整理

### 4. 等待一段時間

等待 5-10 分鐘後查看

**驗證**：
- [ ] 時間自動更新為「5分鐘前」、「10分鐘前」

---

## 更新機制

### 自動更新流程

```
設備上傳資料
  ↓
receiveBeaconData Function
  ↓
更新 elders/{id}.lastActivityAt = 當前時間
  ↓
Firestore 觸發變更事件
  ↓
Community Portal 的 subscribe 接收
  ↓
Table 重新渲染
  ↓
顯示更新後的時間
```

**完全自動，即時更新！**

---

## 相對時間顯示

### 時間格式

使用 `date-fns` 的 `formatDistanceToNow`：

```typescript
formatDistanceToNow(new Date(elder.lastActivityAt), {
  addSuffix: true,
  locale: zhTW,
})
```

**顯示範例**：
- 剛才
- 1分鐘前
- 5分鐘前
- 1小時前
- 2小時前
- 1天前
- 3天前

---

## 完成

最後活動時間更新功能已修正並部署：
- ✅ Cloud Functions 更新長者 lastActivityAt
- ✅ Community Portal 即時顯示
- ✅ 相對時間格式
- ✅ 自動更新
